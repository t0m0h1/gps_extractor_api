<!DOCTYPE html>
<html>
<head>
    <title>Online GPS Extractor & Map Viewer – Upload EXIF Photos</title>
    <meta charset="utf-8" />
    <meta name="description" content="Easily extract GPS coordinates from drone or camera images and view them on a map. Free and fast online tool." />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px auto;
    max-width: 700px;
    background-color: #f9fafb;
    color: #222;
    line-height: 1.6;
    padding: 0 15px;
}

h1 {
    color: #2c3e50;
    font-weight: 700;
    font-size: 2rem;
    margin-bottom: 20px;
    text-align: center;
}

form {
    background: #fff;
    padding: 25px 30px;
    border-radius: 10px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
    justify-content: center;
}

form input[type="file"] {
    flex-grow: 1;
    padding: 8px 12px;
    border: 1.5px solid #ccc;
    border-radius: 8px;
    cursor: pointer;
    transition: border-color 0.3s ease;
}

form input[type="file"]:focus {
    outline: none;
    border-color: #2b6b9d;
}

button {
    background-color: #2b6b9d;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    transition: background-color 0.3s ease, transform 0.15s ease;
    box-shadow: 0 3px 8px rgba(43,107,157,0.4);
    flex-shrink: 0;
}

button:hover,
button:focus {
    background-color: #1d4f75;
    outline: none;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(29,79,117,0.5);
}

#map {
    height: 420px;
    margin-top: 30px;
    border-radius: 12px;
    border: 2px solid #ddd;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
}

#preview {
    max-width: 100%;
    max-height: 300px;
    margin-top: 20px;
    border-radius: 12px;
    border: 1.5px solid #ccc;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    display: none;
    object-fit: contain;
}

#loading {
    color: #2b6b9d;
    margin-top: 15px;
    font-weight: 700;
    font-size: 1.1rem;
    display: none;
    text-align: center;
}

#result {
    margin-top: 30px;
    background: #fff;
    padding: 25px 30px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    word-wrap: break-word;
}

#result p {
    margin: 0.5rem 0;
    font-size: 1rem;
}

#result a {
    color: #2b6b9d;
    text-decoration: none;
    font-weight: 600;
}

#result a:hover {
    text-decoration: underline;
}

#result h3 {
    margin-top: 20px;
    margin-bottom: 12px;
    color: #2c3e50;
}

#result table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
}

#result table td {
    border: 1px solid #ddd;
    padding: 8px 10px;
}

#downloadJson {
    display: none;
    margin-top: 25px;
    padding: 12px 30px;
    border-radius: 8px;
    border: none;
    background-color: #2b6b9d;
    color: white;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    box-shadow: 0 4px 12px rgba(43,107,157,0.5);
    transition: background-color 0.3s ease, transform 0.15s ease;
}

#downloadJson:hover,
#downloadJson:focus {
    background-color: #1d4f75;
    outline: none;
    transform: translateY(-2px);
    box-shadow: 0 7px 15px rgba(29,79,117,0.6);
}

/* Responsive tweaks */
@media (max-width: 480px) {
    form {
        flex-direction: column;
        padding: 20px;
    }

    button, input[type="file"] {
        width: 100%;
        flex-grow: unset;
    }
}

    </style>
</head>
<body>
    <h1>Upload a Photo to Extract GPS</h1>
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" name="file" required />
        <button type="submit">Upload</button>
        <div id="loading">⏳ Processing image...</div>
    </form>

    <img id="preview" alt="Image preview" />

    <div id="map"></div>
    <div id="result"></div>

    <button id="downloadJson">Download EXIF JSON</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const form = document.getElementById('uploadForm');
        const loadingDiv = document.getElementById('loading');
        const preview = document.getElementById('preview');
        const resultDiv = document.getElementById('result');
        const mapDiv = document.getElementById('map');
        const downloadBtn = document.getElementById('downloadJson');
        let map;  // To keep reference to Leaflet map

        // Show image preview on file select
        form.querySelector('input[type="file"]').addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
                preview.src = '';
            }
        });

        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            loadingDiv.style.display = 'block';
            resultDiv.innerHTML = '';
            mapDiv.innerHTML = '';
            downloadBtn.style.display = 'none';

            const formData = new FormData(this);

            try {
                const res = await fetch('/api/extract-gps', {
                    method: 'POST',
                    headers: { 'x-api-key': 'demo-key-123' },
                    body: formData
                });

                const result = await res.json();

                if (res.ok) {
                    const gps = result.gps;
                    const exif = result.exif;

                    let html = '';

                    if (gps) {
                        html += `
                            <p><strong>Latitude:</strong> ${gps.latitude}</p>
                            <p><strong>Longitude:</strong> ${gps.longitude}</p>
                            <p><strong>Altitude:</strong> ${gps.altitude}m</p>
                            <p><a href="${gps.map_link}" target="_blank" rel="noopener noreferrer">View on Google Maps</a></p>
                        `;

                        if (map) {
                            map.remove();
                        }
                        map = L.map('map').setView([gps.latitude, gps.longitude], 16);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                        }).addTo(map);
                        L.marker([gps.latitude, gps.longitude]).addTo(map)
                            .bindPopup('Photo Location')
                            .openPopup();
                    } else {
                        html += '<p style="color:red;">No GPS data available.</p>';
                        if (map) {
                            map.remove();
                            map = null;
                        }
                    }

                    if (exif) {
                        html += '<h3>EXIF Metadata</h3><table style="width:100%; border-collapse: collapse;">';
                        for (const key in exif) {
                            html += `<tr>
                                <td style="border:1px solid #ccc; padding: 4px;"><strong>${key}</strong></td>
                                <td style="border:1px solid #ccc; padding: 4px;">${exif[key]}</td>
                            </tr>`;
                        }
                        html += '</table>';

                        // Show download button and set its behavior
                        downloadBtn.style.display = 'inline-block';
                        downloadBtn.onclick = () => {
                            const blob = new Blob([JSON.stringify(exif, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'exif_data.json';
                            a.click();
                            URL.revokeObjectURL(url);
                        };
                    } else {
                        downloadBtn.style.display = 'none';
                    }

                    resultDiv.innerHTML = html;

                } else {
                    resultDiv.innerHTML = `<p style="color:red;">${result.error}</p>`;
                    downloadBtn.style.display = 'none';
                    if (map) {
                        map.remove();
                        map = null;
                    }
                }

            } catch (error) {
                resultDiv.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
                downloadBtn.style.display = 'none';
                if (map) {
                    map.remove();
                    map = null;
                }
            } finally {
                loadingDiv.style.display = 'none';
            }
        });
    </script>
</body>
</html>
